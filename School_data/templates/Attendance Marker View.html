<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Tailwind configuration for better form clarity */
      .attendance-status {
        display: flex;
        gap: 1rem;
        align-items: center;
      }
      .attendance-status label {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
      }
      .attendance-status input[type="radio"]:checked + label {
        font-weight: 600;
        background-color: #d1e5ff; /* Light blue background for selected */
        border-color: #3b82f6; /* Blue border for selected */
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-2xl space-y-8">
      <h1 class="text-3xl font-extrabold text-indigo-700 border-b pb-4">
        {{ title }}
      </h1>

      <!-- 1. Selection Form for Subject and Date -->
      <form
        method="GET"
        class="space-y-4 p-6 bg-indigo-50 rounded-lg shadow-inner border border-indigo-200"
      >
        <h2 class="text-xl font-semibold text-indigo-800">
          Select Class Session
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div class="col-span-1 md:col-span-2">
            <label
              for="{{ selection_form.subject.id_for_label }}"
              class="block text-sm font-medium text-gray-700"
              >Subject Class</label
            >
            {{ selection_form.subject }}
          </div>
          <div>
            <label
              for="{{ selection_form.attendance_date.id_for_label }}"
              class="block text-sm font-medium text-gray-700"
              >Date</label
            >
            {{ selection_form.attendance_date }}
          </div>
        </div>
        <button
          type="submit"
          class="w-full md:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150"
        >
          Load Roster
        </button>
      </form>

      <!-- 2. Attendance Marking Formset -->
      {% if formset and subject and attendance_date %}
      <form method="POST" class="space-y-6">
        {% csrf_token %}
        <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-lg">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">
            Roster for:
            <span class="text-indigo-600">{{ subject.name }}</span> on {{
            attendance_date }}
          </h2>

          <!-- Hidden fields to pass subject and date back on POST -->
          <input type="hidden" name="subject_id" value="{{ subject.id }}" />
          <input
            type="hidden"
            name="attendance_date"
            value="{{ attendance_date }}"
          />

          {{ formset.management_form }}

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4"
                  >
                    Student
                  </th>
                  <th
                    class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/4"
                  >
                    Status
                  </th>
                  <th
                    class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4"
                  >
                    Notes (Optional)
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for form in formset %}
                <tr class="hover:bg-indigo-50">
                  <!-- Display Student Name (not a form field) -->
                  <td
                    class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                  >
                    {{ form.student_name.initial }} {{ form.student }}
                    <!-- Hidden student ID input -->
                  </td>

                  <!-- Status Radio Buttons -->
                  <td class="px-3 py-4">
                    <div class="attendance-status text-sm">
                      {% for radio in form.status %} {{ radio }} {% endfor %}
                    </div>
                    {% if form.status.errors %}
                    <p class="text-red-500 text-xs mt-1">
                      {{ form.status.errors }}
                    </p>
                    {% endif %}
                  </td>

                  <!-- Notes -->
                  <td class="px-3 py-4">
                    {{ form.notes }} {% if form.notes.errors %}
                    <p class="text-red-500 text-xs mt-1">
                      {{ form.notes.errors }}
                    </p>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if formset.non_field_errors %}
          <div class="p-3 mt-4 bg-red-100 text-red-700 rounded-lg">
            {{ formset.non_field_errors }}
          </div>
          {% endif %}

          <div class="mt-8">
            <button
              type="submit"
              class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-xl hover:bg-green-700 transition duration-150"
            >
              Save Attendance Records
            </button>
          </div>
        </div>
      </form>
      {% endif %}

      <div class="pt-4 border-t mt-6">
        <a
          href="{% url 'teacher_dashboard' %}"
          class="text-sm text-indigo-600 hover:text-indigo-800"
        >
          ‚Üê Back to Teacher Portal
        </a>
      </div>
    </div>
  </body>
</html>
</html>